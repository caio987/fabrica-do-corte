<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agendamento</title>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
  <link rel="stylesheet" href="../style.css">
  <style>
    body{
      text-align: center;
    }
    0
    main #dias {
      max-width: 900px;
      margin: 20px auto;
      background: #000000;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgb(0, 0, 0);
    }

    main #horarios {
      width: 50%;
      margin: auto;
      flex-wrap: wrap;
      display: flex;
      justify-content: space-evenly;
    }

    main .horario {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background-color: #F5A623;
      cursor: pointer;
      transition: 0main .2s;
      font-size: 16px;
    }

    main .horario:hover {
      background-color: #f5a523d2;
    }

    main .selecionado {
      background-color: #ff9800;
      color: white;
    }

    main .caixaServico {
      display: flex;
      justify-content: center;
    }

    main .caixaServico button {
      margin-left: 10px;
    }

    main .funcionarioSelecionado {
      border: solid color #d68400;
    }

    main .funcionarioSelecionado img {
      width: 150px;
    }

    main #confirmacao {
      width: 300px;
      position: fixed;
      top: 50%;
      left: 50%;
    }

    .fc .fc-bg-event {
      opacity: 1;
    }
  </style>
</head>

<body>
  <header>
    <nav>
      <ul>
        <!-- <li><a href="#" class="links">Conta</a></li> -->
      </ul>
    </nav>
  </header>

  <main>
    <h1 id="nome_estabelecimento"></h1>
    <p id="apresentacao" style=""></p>
    <hr>
    <h2>Preencha os espaços para realizar o agendamento</h2>
    <h3>Selecione o dia que deseja</h3>
    <div id="dias"></div>
    <div id="horarios"></div>
    <h3>Selecione os serviços que deseja</h3>
    <div id="servicos"></div>
    <h3>Informações sobre o(s) serviço(s) escolhido(s)</h3><br>
    <div id="resultado"></div>
    <h3>Clique no botão de concluir serviço antes de selecionar o barbeiro que deseja</h3>
    <div id="funcionarios"></div>
    <button onclick="agendar()">Agendar</button>
    <div style="display: none;" id="confirmacao"></div>
  </main>

  <footer class="">
    <a href="#"><img src="../img/icons/github.png" alt=""><span>GitHub</span></a>
    <p>©Todos os direitos reservados a Fábrica do Corte</p>
  </footer>

  <script src="../script.js"></script>
  <script>
    let sucesso = '';
    let idServico = [];
    let idDisponibilidade = '';
    let idFuncionario = '';
    document.addEventListener("DOMContentLoaded", async () => {
      const nome_estabelecimento = document.getElementById('nome_estabelecimento');
      const apresentacao = document.getElementById('apresentacao');
      const horarios = document.getElementById('horarios');
      const servicos = document.getElementById('servicos');
      const resultado = document.getElementById('resultado');
      const funcionarios = document.getElementById('funcionarios');
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      let diaSelecionado = null;
      let horarioSelecionado = null;

      // Busca dados do estabelecimento
      const respostaEstabelecimento = await fetch("../php/estabelecimento.php", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ id })
      });
      const dadosEtabelecimento = await respostaEstabelecimento.json();
      nome_estabelecimento.textContent = dadosEtabelecimento.nome_estabelecimento;
      apresentacao.textContent = dadosEtabelecimento.apresentacao;

      // Busca dias disponíveis
      const respostaDisponibilidade = await fetch("../php/exibirDia.php");
      const dadosDisponibilidade = await respostaDisponibilidade.json();
      const diasCadastrados = dadosDisponibilidade.map(e => e.dia);

      // Inicializa calendário
      const calendarEl = document.getElementById("dias");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "pt-br",
        selectable: true,
        validRange: function (nowDate) {
          const maxDate = new Date(nowDate);
          maxDate.setMonth(maxDate.getMonth() + 3);
          return { start: nowDate, end: maxDate };
        },
        dateClick: function (info) {
          const dataStr = info.dateStr;
          if (!diasCadastrados.includes(dataStr)) {
            alert("Este dia não está disponível para agendamento.");
            return;
          }
          diaSelecionado = diaSelecionado === dataStr ? null : dataStr;
          mostarHorario();
          atualizarEventos();
        }
      });
      calendar.render();
      atualizarEventos();

      function atualizarEventos() {
        calendar.getEvents().forEach(e => e.remove());
        diasCadastrados.forEach(d => calendar.addEvent({ start: d, display: "background", backgroundColor: "#d38400" }));
        if (diaSelecionado) {
          calendar.addEvent({ start: diaSelecionado, title: 'Selecionado', textColor: '#ffff', display: "block", backgroundColor: "#000" });
        }
      }

      async function mostarHorario() {
        horarios.innerHTML = "";
        if (!diaSelecionado) return;
        const respostaHorario = await fetch('../php/exibirHorario.php', {
          headers: { "Content-Type": "application/json" },
          method: 'POST',
          body: JSON.stringify({ dia: diaSelecionado })
        });
        const dadosHorario = await respostaHorario.json();
        dadosHorario.forEach(e => {
          let horario = document.createElement("button");
          horario.innerText = e.horario;
          horario.classList = 'horario';
          horario.addEventListener('click', () => {
            document.querySelectorAll('.horario').forEach(btn => btn.classList.remove('selecionado'));
            horario.classList.add('selecionado');
            horarioSelecionado = e.horario;
          })
          horarios.appendChild(horario);
        });
      }

      // Serviços
      const respostaServico = await fetch("../php/exibirServico.php");
      const dadosServico = await respostaServico.json();


      let precoTotal = 0;

      // Criação dos elementos principais do "carrinho"
      const carrinho = document.createElement('div');
      const preco = document.createElement('p');
      const listaServicos = document.createElement('div'); // ← agora é uma lista, não só texto
      const concluir = document.createElement('button');

      carrinho.appendChild(preco);
      carrinho.appendChild(listaServicos);
      carrinho.appendChild(concluir);

      preco.innerText = "Preço total a pagar: R$ 0,00";
      concluir.innerText = "Concluir";
      resultado.appendChild(carrinho);

      dadosServico.forEach(e => {
        const caixaServico = document.createElement('div');
        const servico = document.createElement('p');
        const adicionar = document.createElement('button');

        caixaServico.classList = 'caixaServico';
        servico.innerText = `${e.nome_servico} - R$ ${e.preco}`;
        adicionar.classList = 'adicionar';
        adicionar.innerText = "Adicionar";

        // Quando clicar em adicionar
        adicionar.addEventListener('click', () => {
          if (idServico.includes(e.id_servico)) {
            alert('Você já adicionou esse serviço');
            return;
          }

          // Adiciona o serviço
          idServico.push(e.id_servico);
          precoTotal += parseFloat(e.preco);
          preco.innerText = `Preço total a pagar: R$ ${precoTotal.toFixed(2)}`;

          // Cria item visível no carrinho
          const item = document.createElement('div');
          item.style.display = "flex";
          item.style.alignItems = "center";
          item.style.justifyContent = "space-between";
          item.style.marginBottom = "5px";

          const nome = document.createElement('span');
          nome.innerText = e.nome_servico;

          const remover = document.createElement('button');
          remover.innerText = "Remover";
          remover.style.backgroundColor = "#d9534f";
          remover.style.color = "white";
          remover.style.border = "none";
          remover.style.padding = "5px 10px";
          remover.style.borderRadius = "5px";
          remover.style.cursor = "pointer";

          // Quando clicar em remover
          remover.addEventListener('click', () => {
            // Remove o ID do array
            idServico = idServico.filter(id => id !== e.id_servico);

            // Atualiza o total
            precoTotal -= parseFloat(e.preco);
            preco.innerText = `Preço total a pagar: R$ ${precoTotal.toFixed(2)}`;

            // Remove o elemento visualmente
            listaServicos.removeChild(item);
          });

          item.appendChild(nome);
          item.appendChild(remover);
          listaServicos.appendChild(item);
        });

        caixaServico.appendChild(servico);
        caixaServico.appendChild(adicionar);
        servicos.appendChild(caixaServico);
      });


      // Concluir e exibir funcionários
      concluir.addEventListener('click', async () => {
        if (idServico.length === 0) {
          alert('Selecione no mínimo 1 serviço');
          return;
        }
        alert('Serviços concluídos!');
        if (!diaSelecionado) { alert('Selecione um dia!'); return; }
        if (!horarioSelecionado) { alert('Selecione um horário!'); return; }

        // Envia dados para PHP
        const dadosParaPHP = {
          id_servico: idServico,
          dia: diaSelecionado,
          horario: horarioSelecionado
        };

        try {
          const resposta = await fetch('../php/exibirFuncionario.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosParaPHP)
          });

          const resultadoPHP = await resposta.json();
          funcionarios.innerHTML = "";

          if (resultadoPHP.status === 'success') {
            sucesso = 'sucesso'
            resultadoPHP.data.forEach(f => {
              const div = document.createElement('div');
              const nome = document.createElement('p');
              const foto = document.createElement('img');
              const botao = document.createElement('button');
              nome.innerText = f.nome;
              foto.src = f.foto;
              botao.innerText = 'Selecionar barbeiro';
              botao.addEventListener('click', () => {
                idFuncionario = f.id_funcionario;
                div.classList = 'funcionarioSelecionado';
                alert(`Funcionário ${f.nome} selecionado`);
              })
              div.innerHTML = ''
              div.appendChild(nome);
              div.appendChild(foto);
              div.appendChild(botao);
              funcionarios.appendChild(div);
            });
          } else {
            funcionarios.innerHTML = `<p>${resultadoPHP.message}</p>`;
          }

        } catch (err) {
          console.error('Erro ao buscar funcionários:', err);
          funcionarios.innerHTML = "<p>Erro ao buscar funcionários.</p>";
        }
      });

    });
    function agendar() {
      if (idFuncionario > 0) {

        let confirmacao = document.getElementById('confirmacao');
        confirmacao.style.display = 'block';
        confirmacao.innerHTML = '';

        // Cria os elementos
        const caixa = document.createElement('div');
        const texto = document.createElement('p');
        const alerta = document.createElement('h3');
        const concluir = document.createElement('button');
        const cancelar = document.createElement('button');
        const fechar = document.createElement('button');

        // Define textos
        alerta.innerText = 'Tem certeza que deseja realizar o agendamento?';
        texto.innerText = 'Clique em "Agendar" se tem certeza. Caso não queira, clique em "Cancelar".';
        concluir.innerText = 'Agendar';
        cancelar.innerText = 'Cancelar';
        fechar.innerText = 'Fechar';

        // Adiciona classes (opcional, para estilizar)
        caixa.classList.add('caixa-confirmacao');
        concluir.classList.add('btn-concluir');
        cancelar.classList.add('btn-cancelar');

        // Adiciona elementos dentro da caixa
        caixa.appendChild(alerta);
        caixa.appendChild(texto);
        caixa.appendChild(concluir);
        caixa.appendChild(cancelar);
        caixa.appendChild(fechar);

        // Adiciona a caixa dentro da div de confirmação
        confirmacao.appendChild(caixa);

        // Eventos
        concluir.addEventListener('click', () => {
          concluirAgendamento(); // sua função
          confirmacao.style.display = 'none';
        });

        cancelar.addEventListener('click', () => {
          confirmacao.style.display = 'none';
        });

        fechar.addEventListener('click', () => {
          confirmacao.style.display = 'none';
        });
      } else {
        alert('Preencha os outros campos antes de agendar')
      }
    }

    async function concluirAgendamento() {
      if (sucesso == 'sucesso') {
        //Agendamento        
        const idsAgendamento = {
          id_servico: idServico,         // array de serviços
          id_funcionario: idFuncionario,
          id_disponibilidade: idDisponibilidade

        };



        const respostaAgendamento = await fetch('../php/agendamento.php', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(idsAgendamento)
        });
        const dadosAgendamento = await respostaAgendamento.text();
        console.log(dadosAgendamento)
        alert(dadosAgendamento)
        if (dadosAgendamento == 'Agendamento realizado com sucesso') {
          window.location.href = "agendamentoSalvo.html"
        } else {
          location.reload();
        }
      } else {
        alert('Você pulou alguma etapa do agendamento!')
      }
    }
  </script>
</body>

</html>