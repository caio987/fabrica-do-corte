<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página do Cliente</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <div style="margin-top: 15px; display: flex; justify-content: space-evenly; flex-wrap: wrap;" id="link"></div>
    
    <div style="max-width: 500px; text-align: center; padding: 0 10px;" id="caixa"></div>

    <h2>Seus agendamentos</h2>
    <div id="agendamento"></div>
    <hr>
    <br><br>

    <h3>Estabelecimentos Salvos</h3>
    <div id="estabelecimentos"></div>

    <script>
        const link = document.getElementById('link');
        const agendamento = document.getElementById('agendamento');
        const estabelecimentos = document.getElementById('estabelecimentos');

        // Menu superior
        let links = `
            <a href="infoContaCliente.html" class="link ativo">Informações da conta</a>
            <a href="#" class="link">Agendamento</a>
        `;
        link.innerHTML = links;

        document.addEventListener('DOMContentLoaded', async () => {

            // ==================== AGENDAMENTOS ====================
            const respostaAgendamento = await fetch('../php/agendamentoSalvo.php');
            const dadosAgendamento = await respostaAgendamento.json();
            let total = 0;

            console.log(dadosAgendamento);

            dadosAgendamento.forEach(e => {
                if (e.tipo === 'Cliente') {
                    const foto = document.createElement('img');
                    const nome = document.createElement('p');
                    const local = document.createElement('p');
                    const fotoBarbeiro = document.createElement('img');
                    const barbeiro = document.createElement('p');
                    const totalPagar = document.createElement('p');

                    foto.src = e.foto;
                    nome.innerText = e.estabelecimento;
                    local.innerText = e.localizacao;
                    fotoBarbeiro.src = e.foto_barbeiro;
                    barbeiro.innerText = e.funcionario;

                    agendamento.appendChild(foto);
                    agendamento.appendChild(nome);
                    agendamento.appendChild(local);
                    agendamento.appendChild(fotoBarbeiro);
                    agendamento.appendChild(barbeiro);

                    e.servicos.forEach(s => {
                        total += parseFloat(s.preco);
                        const servico = document.createElement('p');
                        servico.innerText = s.nome_servico;
                        const preco = document.createElement('p');
                        preco.innerText = s.preco;
                        agendamento.appendChild(servico);
                        agendamento.appendChild(preco);
                    });

                    totalPagar.innerText = "Total a pagar: R$ " + total.toFixed(2);
                    agendamento.appendChild(totalPagar);

                } else if (e.tipo === 'Proprietário') {
                    const nome = document.createElement('p');
                    const fotoBarbeiro = document.createElement('img');
                    const barbeiro = document.createElement('p');
                    const totalPagar = document.createElement('p');

                    nome.innerText = e.cliente;
                    fotoBarbeiro.src = e.foto_barbeiro;
                    barbeiro.innerText = e.funcionario;

                    agendamento.appendChild(nome);
                    agendamento.appendChild(fotoBarbeiro);
                    agendamento.appendChild(barbeiro);

                    e.servicos.forEach(s => {
                        total += parseFloat(s.preco);
                        const servico = document.createElement('p');
                        servico.innerText = s.nome_servico;
                        const preco = document.createElement('p');
                        preco.innerText = s.preco;
                        agendamento.appendChild(servico);
                        agendamento.appendChild(preco);
                    });

                    totalPagar.innerText = "Total a receber: R$ " + total.toFixed(2);
                    agendamento.appendChild(totalPagar);
                }
            });

            // ==================== ESTABELECIMENTOS SALVOS ====================
            const respostaEstabelecimento = await fetch("../php/exibirEstabelecimentosSalvos.php");
            const dadosEstabelecimento = await respostaEstabelecimento.json();

            dadosEstabelecimento.forEach(e => {
                const caixaInvisivel = document.createElement("div");
                caixaInvisivel.classList.add("caixaInvisivel");

                const caixaGeral = document.createElement("div");
                caixaGeral.classList.add("caixaGeral");

                caixaGeral.onclick = () => {
                    caixaGeral.classList.toggle("active");
                    caixaInvisivel.classList.toggle("active");
                };

                const caixa = document.createElement("div");
                caixa.classList.add("caixaBarbearia");

                const foto = document.createElement("img");
                foto.classList.add("fotoBarbearia");
                foto.src = e.foto_estabelecimento || "../img/default-logo.png";
                foto.alt = e.nome_estabelecimento || "Estabelecimento";

                const nome = document.createElement("a");
                nome.classList.add("nomeEstabelecimento");
                nome.innerText = e.nome_estabelecimento || "Sem nome";
                nome.href = `estabelecimento.html?id=${e.id_estabelecimento}`;

                const avaliacao = document.createElement("div");
                avaliacao.classList.add("avaliacao");
                const nota = document.createElement("img");
                nota.src = "../img/icons/avaliacao.png";
                avaliacao.appendChild(nota);

                const caixaInformacoes = document.createElement("div");
                caixaInformacoes.classList.add("caixaInformacoes");

                const localizacao = document.createElement("p");
                localizacao.classList.add("localizacao");
                localizacao.innerText = "Localização: " + (e.localizacao || "Não informada");

                const contato = document.createElement("p");
                contato.classList.add("contato");
                contato.innerText = "Contato: " + (e.telefone_estabelecimento || "Não informado");

                const div1 = document.createElement("div");
                const texto1 = document.createElement("p");
                texto1.innerHTML = "Foto de nossa barbearia";

                const fotoExtra = document.createElement("img");
                fotoExtra.src = e.foto_estabelecimento || "../img/default-foto.png";
                fotoExtra.alt = "Foto do local";
                fotoExtra.classList.add("fotoBarbearia");
                div1.appendChild(texto1);
                div1.appendChild(fotoExtra);

                const div2 = document.createElement("div");
                const texto2 = document.createElement("p");
                texto2.innerHTML = "Um pouco sobre nossos serviços";

                const sinopse = document.createElement("p");
                sinopse.classList.add("sinopse");
                sinopse.innerText = e.apresentacao || "Sem descrição disponível.";
                div2.appendChild(texto2);
                div2.appendChild(sinopse);

                const seta = document.createElement("img");
                seta.src = "../img/icons/seta.png";
                seta.classList.add("seta");

                const salvarBarbearia = document.createElement("button");
                salvarBarbearia.classList.add("salvarBarbearia");
                salvarBarbearia.innerText = "Salvar Barbearia";

                salvarBarbearia.addEventListener('click', async () => {
                    let id = e.id_estabelecimento;
                    const resposta = await fetch("../php/salvar.php", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id_estabelecimento: id })
                    });

                    const dados = await resposta.json();
                    alert(dados.mensagem || "Operação concluída!");
                });

                // Montagem dos elementos
                caixaInformacoes.appendChild(nome);
                caixaInformacoes.appendChild(avaliacao);
                caixaInformacoes.appendChild(localizacao);
                caixaInformacoes.appendChild(contato);

                caixaInvisivel.appendChild(div1);
                caixaInvisivel.appendChild(div2);

                caixa.appendChild(foto);
                caixa.appendChild(caixaInformacoes);
                caixa.appendChild(seta);

                caixaGeral.appendChild(caixa);
                caixaGeral.appendChild(caixaInvisivel);
                caixaGeral.appendChild(salvarBarbearia);

                estabelecimentos.appendChild(caixaGeral);
            });
        });
    </script>
    <script src="../script.js"></script>
</body>
</html>
