<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página do Cliente</title>
    <link rel="stylesheet" href="../style.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        main #caixaEstabelecimento .caixaGeral {
            padding: 15px;
        }

        main .caixaGeral:hover {
            scale: 1;
        }

        main .caixaInformacoes p {
            margin: 4px 10px;
            font-size: 1.2em;
            color: #fff;
        }

        main .caixaInvisivel div {
            width: 60%;
        }

        main .caixaInvisivel p {
            margin: 10px;
        }

        main #agendamento .caixaGeral .fotoBarbearia {
            width: 200px;
            height: 145px;
        }

        main .fotoBarbeiro {
            width: 150px;
            height: 150px;
            margin: 10px 0px;
            border-radius: 10px;
        }

        @media(max-width:767px) {

            main .caixaGeral,
            main #agendamento .caixaGeral {
                font-size: .8em;
                width: 100%;
            }

            main .caixaGeral p {
                width: 100%;
            }

            main .caixaInformacoes p {
                margin: 4px 13px;
                font-size: .9em;
            }

            main .caixaGeral p span {
                font-size: .9em;
            }

            main #agendamento .caixaGeral .fotoBarbearia {
                width: 130px;
                height: 100px;
            }

            main .caixaGeral button {
                width: 75%;
                margin-left: 30px;
            }

            main .caixaGeral button:hover {
                width: 80%;
                font-size: .8em;
                padding: 6px;
            }

            main .fotoBarbeiro {
                width: 100px;
                height: 100px;
            }

            .nomeCliente {
                color: white;
            }
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <ul></ul>
        </nav>
    </header>

    <main>
        <div style="margin-top: 15px; display: flex; justify-content: space-evenly; flex-wrap: wrap;" id="link"></div>

        <h2>Seus agendamentos</h2>
        <div id="agendamento"></div>
        <hr class="some">

        <h3 id="estabelecimentoSalvo"></h3>
        <div class="some" id="caixaEstabelecimento"></div>
    </main>

    <footer class="footerFixo">
        <a href="#"><img src="../img/icons/github.png" alt=""><span>GitHub</span></a>
        <p>©Todos os direitos reservados a Fábrica do Corte</p>
    </footer>

    <script>
        const link = document.getElementById('link');
        const agendamento = document.getElementById('agendamento');
        const estabelecimentos = document.getElementById('caixaEstabelecimento');

        link.innerHTML = `
            <a href="infoContaCliente.html" class="link ativo">Informações da conta</a>
            <a href="#" class="link">Agendamento</a>
        `;
        
        document.addEventListener('DOMContentLoaded', async () => {
            
            // ==================== AGENDAMENTOS ====================
            const resposta = await fetch('../php/informacoes.php');
            const dados = await resposta.json();
            
            if (dados.tipo == 'Proprietário') {
                link.innerHTML = `
                <a href="infoContaCliente.html" class="link ativo">Informações da conta</a>
            <a href="#" class="link">Agendamento</a>
                    <a href="gerenciaEstabelecimento.html" class="link">Estabelecimento</a>
                `;
                
                try {
                    const respostaAgendamento = await fetch('../php/agendamentoSalvo.php');
                    const dadosAgendamento = await respostaAgendamento.json();

                    dadosAgendamento.forEach(e => {
                        let total = 0;

                        const caixaGeral = document.createElement("div");
                        caixaGeral.classList.add("caixaGeral");

                        const nome = document.createElement('h2');
                        nome.classList.add("nomeCliente");
                        nome.innerHTML = `<span style="color:#C4974F;">Nome do Cliente:</span> <span style="color:#C4974F;"> ${e.cliente}`;

                        const horario = document.createElement('p');
                        horario.innerHTML = `<span style="color:#C4974F;">Horário:</span> <span style="color:#ffffff;">${e.horario || "Não informada"}</span>`;

                        const dia = document.createElement('p');
                        dia.innerHTML = `<span style="color:#C4974F;">Dia: </span> <span style="color:#ffffff;">${e.dia || "Não informada"}</span>`;

                        const barbeiro = document.createElement('p');
                        barbeiro.innerHTML = `<span style="color:#C4974F;">Barbeiro escolhido: </span> <span style="color:#ffffff;">${e.funcionario || "Não informada"}</span>`;

                        const fotoBarbeiro = document.createElement('img');
                        fotoBarbeiro.classList.add("fotoBarbeiro");
                        fotoBarbeiro.src = e.foto_barbeiro;

                        const totalPagar = document.createElement('p');

                        const cancelar = document.createElement("button");
                        cancelar.innerText = "Cancelar agendamento";
                        cancelar.classList.add("buttonBonito");

                        cancelar.onclick = () => cancelarA(e.id_agendamento);

                        const caixaBarbearia = document.createElement("div");
                        caixaBarbearia.classList.add("caixaBarbearia");

                        const caixaInformacoes = document.createElement("div");
                        caixaInformacoes.classList.add("caixaInformacoes");

                        const caixaInvisivel = document.createElement("div");
                        caixaInvisivel.classList.add("caixaInvisivel");

                        const div = document.createElement("div");

                        const seta = document.createElement("img");
                        seta.src = "../img/icons/seta.png";
                        seta.classList.add("seta");

                        seta.onclick = () => {
                            caixaGeral.classList.toggle("active");
                            caixaInvisivel.classList.toggle("active");
                        };

                        const algo = document.createElement('p');
                        algo.innerHTML = "Corte(s) selecionado(s)";
                        div.appendChild(algo);

                        e.servicos.forEach(s => {
                            total += parseFloat(s.preco);
                            const servico = document.createElement('p');
                            servico.innerText = s.nome_servico;
                            div.appendChild(servico);
                        });

                        totalPagar.innerText = "Total a pagar: R$ " + total.toFixed(2);

                        caixaInformacoes.appendChild(nome);
                        caixaInformacoes.appendChild(dia);
                        caixaInformacoes.appendChild(horario);
                        caixaInformacoes.appendChild(barbeiro);

                        caixaBarbearia.appendChild(caixaInformacoes);
                        caixaBarbearia.appendChild(seta);

                        div.appendChild(totalPagar);
                        div.appendChild(cancelar);

                        caixaInvisivel.appendChild(fotoBarbeiro);
                        caixaInvisivel.appendChild(div);

                        caixaGeral.appendChild(caixaBarbearia);
                        caixaGeral.appendChild(caixaInvisivel);
                        agendamento.appendChild(caixaGeral);
                    });

                } catch (erro) {
                    Swal.fire({
                        title: 'Erro',
                        text: 'Não foi possível carregar os agendamentos!',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                    console.error('Erro ao carregar agendamentos:', erro);
                }

            } else {

                const respostaAgendamento = await fetch('../php/agendamentoSalvo.php');
                const dadosAgendamento = await respostaAgendamento.json();
                let total = 0;

                dadosAgendamento.forEach(e => {

                    if (e.tipo === 'Cliente') {

                        const caixaGeral = document.createElement("div");
                        caixaGeral.classList.add("caixaGeral");

                        const foto = document.createElement('img');
                        foto.src = e.foto;
                        foto.classList.add("fotoBarbearia")

                        const nome = document.createElement('h2');
                        nome.classList.add("nomeEstabelecimento")
                        nome.innerHTML = e.estabelecimento;

                        const local = document.createElement('p');
                        local.innerHTML = `<span style="color:#C4974F;">localização:</span> <span style="color:#ffffff;">${e.localizacao || "Não informada"}</span>`;

                        const horario = document.createElement('p');
                        horario.innerHTML = `<span style="color:#C4974F;">Horário:</span> <span style="color:#ffffff;">${e.horario || "Não informada"}</span>`;

                        const dia = document.createElement('p');
                        dia.innerHTML = `<span style="color:#C4974F;">Dia: </span> <span style="color:#ffffff;">${e.dia || "Não informada"}</span>`;

                        const barbeiro = document.createElement('p');
                        barbeiro.innerHTML = `<span style="color:#C4974F;">Barbeiro escolhido: </span> <span style="color:#ffffff;">${e.funcionario || "Não informada"}</span>`;

                        const fotoBarbeiro = document.createElement('img');
                        fotoBarbeiro.classList.add("fotoBarbeiro")
                        fotoBarbeiro.src = e.foto_barbeiro;

                        const totalPagar = document.createElement('p');

                        const cancelar = document.createElement("button");
                        cancelar.innerText = "Cancelar agendamento";
                        cancelar.classList.add("buttonBonito");

                        cancelar.onclick = () => cancelarA(e.id_agendamento);

                        const caixaBarbearia = document.createElement("div");
                        caixaBarbearia.classList.add("caixaBarbearia")

                        const caixaInformacoes = document.createElement("div");
                        caixaInformacoes.classList.add("caixaInformacoes")

                        const caixaInvisivel = document.createElement("div");
                        caixaInvisivel.classList.add("caixaInvisivel")

                        const div = document.createElement("div");

                        const seta = document.createElement("img");
                        seta.src = "../img/icons/seta.png";
                        seta.classList.add("seta");

                        seta.onclick = () => {
                            caixaGeral.classList.toggle("active");
                            caixaInvisivel.classList.toggle("active");
                        };

                        algo = document.createElement('p')
                        algo.innerHTML = "Corte(s) selecionado(s)"

                        div.appendChild(algo)

                        e.servicos.forEach(s => {
                            total += parseFloat(s.preco);
                            const servico = document.createElement('p');
                            servico.innerText = s.nome_servico;

                            div.appendChild(servico);
                        });

                        totalPagar.innerText = "Total a pagar: R$ " + total.toFixed(2);

                        caixaInformacoes.appendChild(nome);
                        caixaInformacoes.appendChild(dia);
                        caixaInformacoes.appendChild(horario);
                        caixaInformacoes.appendChild(local);
                        caixaInformacoes.appendChild(barbeiro);

                        caixaBarbearia.appendChild(foto);
                        caixaBarbearia.appendChild(caixaInformacoes)
                        caixaBarbearia.appendChild(seta);

                        div.appendChild(totalPagar);
                        div.appendChild(cancelar)

                        caixaInvisivel.appendChild(fotoBarbeiro)
                        caixaInvisivel.appendChild(div)

                        caixaGeral.appendChild(caixaBarbearia);
                        caixaGeral.appendChild(caixaInvisivel);
                        agendamento.appendChild(caixaGeral)

                    }
                })
            }

            // ==================== ESTABELECIMENTOS SALVOS ====================
            try {
                const respostaInfo = await fetch("../php/informacoes.php");
                const dadosInfo = await respostaInfo.json();

                if (dadosInfo.tipo == 'Cliente') {
                    const texto = document.getElementById('estabelecimentoSalvo');
                    texto.innerHTML = 'Estabelecimentos Salvos';

                    const respostaEstabelecimento = await fetch("../php/exibirEstabelecimentosSalvos.php");
                    const dadosEstabelecimento = await respostaEstabelecimento.json();

                    dadosEstabelecimento.forEach(e => {
                        const caixaGeral = document.createElement("div");
                        caixaGeral.classList.add("caixaGeral");

                        const fotoExtra = document.createElement("img");
                        fotoExtra.src = e.foto_estabelecimento || "../img/default-foto.png";
                        fotoExtra.classList.add("fotoBarbearia");

                        const nome = document.createElement("a");
                        nome.classList.add("nomeEstabelecimento");
                        nome.style.margin = "0px";
                        nome.innerText = e.nome_estabelecimento || "Sem nome";
                        nome.href = `estabelecimento.html?id=${e.id_estabelecimento}`;

                        const nota = document.createElement("img");
                        nota.style.display = "block";
                        nota.style.margin = "4px auto";
                        nota.src = "../img/icons/avaliacao.png";

                        const excluir = document.createElement("button");
                        excluir.innerText = "Excluir";
                        excluir.classList.add("buttonBonito");

                        excluir.addEventListener('click', async () => {
                            try {
                                const resposta = await fetch(`../php/excluirEstabelecimentoSalvo.php?id=${e.id_estabelecimento_salvo}`);
                                const dados = await resposta.text();

                                if (dados.toLowerCase().includes('erro')) {
                                    Swal.fire({
                                        title: 'Erro',
                                        text: dados,
                                        icon: 'error',
                                        confirmButtonText: 'OK'
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Sucesso',
                                        text: dados,
                                        icon: 'success',
                                        confirmButtonText: 'OK'
                                    }).then(() => location.reload());
                                }
                            } catch (erro) {
                                Swal.fire({
                                    title: 'Erro',
                                    text: 'Não foi possível conectar ao servidor!',
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                                console.error('Erro ao excluir estabelecimento:', erro);
                            }
                        });

                        const caixa = document.createElement("div");
                        caixa.classList.add("caixaInformacoes");
                        caixa.style.textAlign = "center";

                        caixaGeral.appendChild(fotoExtra);
                        caixa.appendChild(nome);
                        caixa.appendChild(nota);
                        caixa.appendChild(excluir);
                        caixaGeral.appendChild(caixa);

                        estabelecimentos.appendChild(caixaGeral);
                    });
                }
            } catch (erro) {
                Swal.fire({
                    title: 'Erro',
                    text: 'Não foi possível carregar os estabelecimentos!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                console.error('Erro ao carregar estabelecimentos:', erro);
            }

        });

        // ====================== FUNÇÃO CORRIGIDA ======================
        async function cancelarA(id) {
            try {
                const resposta = await fetch(`../php/cancelarAgendamento.php?id=${id}`);
                const dados = await resposta.text();
                console.log(dados);

                if (dados.toLowerCase().includes('erro')) {
                    Swal.fire({
                        title: 'Erro',
                        text: dados,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire({
                        title: 'Sucesso',
                        text: dados,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => location.reload());
                }

            } catch (erro) {
                Swal.fire({
                    title: 'Erro',
                    text: 'Não foi possível conectar ao servidor!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                console.error('Erro ao cancelar agendamento:', erro);
            }
        }
    </script>

    <script src="../script.js"></script>
</body>

</html>